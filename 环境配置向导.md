# ğŸ”§ ç¯å¢ƒé…ç½®å‘å¯¼

## ğŸ“ é…ç½®æ¸…å•

ä»¥ä¸‹æ˜¯éƒ¨ç½²ä¸´æ—¶é‚®ç®±ç³»ç»Ÿéœ€è¦çš„æ‰€æœ‰é…ç½®é¡¹ã€‚è¯·æŒ‰é¡ºåºå®Œæˆã€‚

---

## 1ï¸âƒ£ Cloudflare API Token

### è·å–æ­¥éª¤

1. è®¿é—®ï¼šhttps://dash.cloudflare.com/profile/api-tokens
2. ç‚¹å‡» **"Create Token"**
3. é€‰æ‹© **"Create Custom Token"**
4. é…ç½®å¦‚ä¸‹ï¼š

   **Token name:**
   ```
   TempEmail-API-Token
   ```

   **Permissions:**
   ```
   Zone - Email Routing Rules - Edit
   Zone - Zone Settings - Read
   Zone - Zone - Read
   Account - D1 - Edit (å¯é€‰)
   ```

   **Zone Resources:**
   ```
   Include - Specific zone - [é€‰æ‹©ä½ çš„åŸŸå]
   ```

   **Client IP Address Filteringï¼ˆå¯é€‰ï¼‰:**
   ```
   ä¸å¡«å†™ï¼šé»˜è®¤æ‰€æœ‰å®¢æˆ·ç«¯ IP å¯ä½¿ç”¨è¯¥ Tokenï¼ˆå¼€å‘é˜¶æ®µæ›´æ–¹ä¾¿ï¼‰
   å»ºè®®ï¼šå¡«å†™ä½ å½“å‰çš„å…¬ç½‘ IPï¼ˆæˆ–å…¬å¸å‡ºå£ IP æ®µï¼‰ï¼Œæå‡å®‰å…¨æ€§
   è¯´æ˜ï¼šå¯é€‰æ‹©â€œin / not in / equalsâ€ç­‰è¿ç®—ç¬¦ï¼Œæ”¯æŒå•ä¸ª IP æˆ– CIDR ç½‘æ®µ
   å˜æ›´ï¼šå…¬ç½‘ IP å˜åŒ–åï¼Œéœ€æ›´æ–°æ­¤ç™½åå•ï¼Œå¦åˆ™ Token å°†æ— æ³•ä½¿ç”¨
   ```

5. ç‚¹å‡» **"Continue to summary"**
6. ç‚¹å‡» **"Create Token"**
7. **å¤åˆ¶å¹¶ä¿å­˜** Tokenï¼ˆåªæ˜¾ç¤ºä¸€æ¬¡ï¼ï¼‰

### é…ç½®ä½ç½®
```bash
# workers/.dev.vars
CLOUDFLARE_API_TOKEN=your_token_here
```

---

## 2ï¸âƒ£ Zone ID

### è·å–æ­¥éª¤

1. ç™»å½• [Cloudflare Dashboard](https://dash.cloudflare.com)
2. é€‰æ‹©ä½ çš„åŸŸå
3. åœ¨å³ä¾§æ æ‰¾åˆ° **"Zone ID"**
4. ç‚¹å‡»å¤åˆ¶æŒ‰é’®

### ç¤ºä¾‹
```
Zone ID: 56a7280c5ca19f3f5ed4820465fd96ee
```

### é…ç½®ä½ç½®
```bash
# workers/.dev.vars
CLOUDFLARE_ZONE_ID=your_zone_id_here

# workers/wrangler.tomlï¼ˆå¯é€‰ï¼‰
```

---

## 3ï¸âƒ£ Account ID

### è·å–æ­¥éª¤

1. åœ¨åŒä¸€é¡µé¢ï¼ˆåŸŸåæ¦‚è§ˆï¼‰
2. å³ä¾§æ æ‰¾åˆ° **"Account ID"**
3. ç‚¹å‡»å¤åˆ¶æŒ‰é’®

### ç¤ºä¾‹
```
Account ID: abcdef1234567890abcdef1234567890
```

### é…ç½®ä½ç½®
```bash
# workers/.dev.vars
CLOUDFLARE_ACCOUNT_ID=your_account_id_here
```

---

## 4ï¸âƒ£ åŸŸåé…ç½®

### è¦æ±‚

- âœ… åŸŸåå¿…é¡»æ‰˜ç®¡åœ¨ Cloudflareï¼ˆä½¿ç”¨ Cloudflare DNSï¼‰
- âœ… åŸŸåçŠ¶æ€å¿…é¡»æ˜¯ **Active**
- âœ… å»ºè®®ä½¿ç”¨äºŒçº§åŸŸåï¼ˆä¾‹å¦‚ï¼šmail.yourdomain.comï¼‰

### é…ç½®æ­¥éª¤

1. ç¡®è®¤åŸŸåå·²æ·»åŠ åˆ° Cloudflare
2. DNS è®°å½•æ­£ç¡®é…ç½®
3. å¡«å…¥é…ç½®ï¼š

```bash
# workers/.dev.vars
DOMAIN_NAME=yourdomain.com

# æˆ–ä½¿ç”¨å­åŸŸå
DOMAIN_NAME=mail.yourdomain.com
```

---

## 5ï¸âƒ£ Email Routing è®¾ç½®

### å¯ç”¨æ­¥éª¤

1. è¿›å…¥ Cloudflare Dashboard
2. é€‰æ‹©åŸŸå
3. å·¦ä¾§èœå•é€‰æ‹© **"Email" > "Email Routing"**
4. ç‚¹å‡» **"Get Started"**

### é…ç½®ç›®æ ‡é‚®ç®±

1. åœ¨ **"Destination addresses"** éƒ¨åˆ†
2. ç‚¹å‡» **"Add destination address"**
3. è¾“å…¥ä½ çš„ QQ é‚®ç®±
4. ç‚¹å‡» **"Send"**

### éªŒè¯é‚®ç®±

1. æ‰“å¼€ QQ é‚®ç®±
2. æŸ¥æ”¶éªŒè¯é‚®ä»¶ï¼ˆæ¥è‡ª Cloudflareï¼‰
3. ç‚¹å‡»éªŒè¯é“¾æ¥
4. è¿”å› Cloudflare Dashboard
5. ç¡®è®¤çŠ¶æ€å˜ä¸º **"Verified"**

### é…ç½®ä½ç½®
```bash
# workers/.dev.vars
TARGET_EMAIL=your@qq.com
```

---

## 6ï¸âƒ£ QQ é‚®ç®± IMAP æˆæƒç 

### è·å–æ­¥éª¤

1. ç™»å½• [QQ é‚®ç®±](https://mail.qq.com)
2. ç‚¹å‡» **"è®¾ç½®" > "è´¦æˆ·"**
3. æ‰¾åˆ° **"POP3/IMAP/SMTP/Exchange/CardDAV/CalDAVæœåŠ¡"**
4. å¼€å¯ **"IMAP/SMTPæœåŠ¡"**
5. ç‚¹å‡» **"ç”Ÿæˆæˆæƒç "**
6. æŒ‰æç¤ºå‘é€çŸ­ä¿¡
7. **å¤åˆ¶å¹¶ä¿å­˜** æˆæƒç 

### æ³¨æ„äº‹é¡¹
âš ï¸ **æˆæƒç ä¸æ˜¯QQå¯†ç ï¼**
âš ï¸ **æˆæƒç åªæ˜¾ç¤ºä¸€æ¬¡ï¼Œè¯·å¦¥å–„ä¿å­˜**

### é…ç½®ä½ç½®
```bash
# workers/.dev.vars
QQ_IMAP_PASSWORD=your_authorization_code_here
```

---

## 7ï¸âƒ£ D1 æ•°æ®åº“é…ç½®

### åˆ›å»ºæ•°æ®åº“

```bash
cd workers
npx wrangler d1 create tempemail
```

### è¾“å‡ºç¤ºä¾‹
```
âœ… Successfully created DB 'tempemail'

[[d1_databases]]
binding = "DB"
database_name = "tempemail"
database_id = "12345678-1234-1234-1234-123456789abc"
```

### é…ç½®æ­¥éª¤

1. å¤åˆ¶è¾“å‡ºçš„ `database_id`
2. ç¼–è¾‘ `workers/wrangler.toml`
3. æ‰¾åˆ°è¿™ä¸€è¡Œï¼š
   ```toml
   database_id = "your-database-id-here"
   ```
4. æ›¿æ¢ä¸ºå®é™…çš„ `database_id`

### åˆå§‹åŒ–æ•°æ®åº“

```bash
npx wrangler d1 execute tempemail --file=schema.sql
```

---

## 8ï¸âƒ£ å‰ç«¯ç¯å¢ƒå˜é‡

### å¼€å‘ç¯å¢ƒ

åˆ›å»º `frontend/.env`ï¼š

```env
# API åŸºç¡€åœ°å€
VITE_API_BASE=/api

# WebSocket åœ°å€
VITE_WS_URL=ws://localhost:8787/ws
```

### ç”Ÿäº§ç¯å¢ƒ

åˆ›å»º `frontend/.env.production`ï¼š

```env
# æ›¿æ¢ä¸ºä½ çš„ Worker URL
VITE_API_BASE=https://tempemail-api.your-subdomain.workers.dev/api

# WebSocket åœ°å€
VITE_WS_URL=wss://tempemail-api.your-subdomain.workers.dev/ws
```

---

## 9ï¸âƒ£ Workers ç¯å¢ƒå˜é‡

### æœ¬åœ°å¼€å‘

åˆ›å»º `workers/.dev.vars`ï¼š

```env
# Cloudflare API é…ç½®
CLOUDFLARE_API_TOKEN=your_api_token_here
CLOUDFLARE_ACCOUNT_ID=your_account_id_here
CLOUDFLARE_ZONE_ID=your_zone_id_here

# åŸŸåé…ç½®
DOMAIN_NAME=yourdomain.com

# ç›®æ ‡é‚®ç®±
TARGET_EMAIL=your@qq.com

# QQé‚®ç®±æˆæƒç ï¼ˆå¦‚æœä½¿ç”¨å¤–éƒ¨ç›‘æ§ï¼‰
QQ_IMAP_PASSWORD=your_imap_authorization_code

# ç›‘æ§é…ç½®
MONITOR_INTERVAL=10
AUTO_DELETE_DAYS=7
```

### ç”Ÿäº§ç¯å¢ƒ

åœ¨ Cloudflare Dashboard é…ç½®ï¼š

1. è¿›å…¥ **Workers & Pages**
2. é€‰æ‹©ä½ çš„ Worker
3. ç‚¹å‡» **Settings**
4. é€‰æ‹© **Variables**
5. æ·»åŠ ç¯å¢ƒå˜é‡ï¼ˆåŒä¸Šï¼‰

---

## ğŸ”Ÿ é‚®ä»¶ Worker é…ç½®

### éƒ¨ç½²åé…ç½®

1. éƒ¨ç½² Workerï¼š
   ```bash
   cd workers
   npx wrangler deploy
   ```

2. è®°ä¸‹ Worker URLï¼š
   ```
   https://tempemail-api.your-subdomain.workers.dev
   ```

3. é…ç½® Email Workerï¼š
   - è¿›å…¥ Cloudflare Dashboard
   - Email Routing > Email Workers
   - ç‚¹å‡» **Add route**
   - Match type: **Catch-all**
   - Action: **Send to Worker**
   - Worker: é€‰æ‹©ä½ çš„ Worker
   - ç‚¹å‡» **Save**

---

## âœ… é…ç½®éªŒè¯

### æ£€æŸ¥æ¸…å•

- [ ] Cloudflare API Token å·²è·å–å¹¶é…ç½®
- [ ] Zone ID å·²é…ç½®
- [ ] Account ID å·²é…ç½®
- [ ] åŸŸåå·²é…ç½®
- [ ] Email Routing å·²å¯ç”¨
- [ ] QQ é‚®ç®±å·²éªŒè¯
- [ ] QQ IMAP æˆæƒç å·²è·å–
- [ ] D1 æ•°æ®åº“å·²åˆ›å»º
- [ ] æ•°æ®åº“å·²åˆå§‹åŒ–
- [ ] å‰ç«¯ç¯å¢ƒå˜é‡å·²é…ç½®
- [ ] Workers ç¯å¢ƒå˜é‡å·²é…ç½®
- [ ] Email Worker å·²é…ç½®

### æµ‹è¯•é…ç½®

#### 1. æµ‹è¯• API Token

```bash
cd workers
npx wrangler whoami
```

åº”è¯¥æ˜¾ç¤ºä½ çš„è´¦å·ä¿¡æ¯ã€‚

#### 2. æµ‹è¯• D1 æ•°æ®åº“

```bash
npx wrangler d1 execute tempemail --command="SELECT * FROM config"
```

åº”è¯¥è¿”å›é…ç½®æ•°æ®ã€‚

#### 3. æµ‹è¯• Workers

```bash
npm run dev
```

è®¿é—® http://localhost:8787/api/config åº”è¯¥è¿”å›JSONå“åº”ã€‚

#### 4. æµ‹è¯•å‰ç«¯

```bash
cd frontend
npm run dev
```

è®¿é—® http://localhost:5173 åº”è¯¥çœ‹åˆ°ç•Œé¢ã€‚

---

## ğŸ› å¸¸è§é…ç½®é”™è¯¯

### é”™è¯¯ 1: "Authentication error"

**åŸå› **: API Token æ— æ•ˆæˆ–æƒé™ä¸è¶³

**è§£å†³**:
1. æ£€æŸ¥ Token æ˜¯å¦æ­£ç¡®å¤åˆ¶
2. ç¡®è®¤ Token æƒé™åŒ…å« Email Routing
3. é‡æ–°ç”Ÿæˆ Token

### é”™è¯¯ 2: "Zone not found"

**åŸå› **: Zone ID é”™è¯¯æˆ–åŸŸåæœªæ¿€æ´»

**è§£å†³**:
1. ç¡®è®¤ Zone ID æ­£ç¡®
2. æ£€æŸ¥åŸŸåçŠ¶æ€æ˜¯å¦ä¸º Active
3. ç¡®è®¤åŸŸåå·²æ·»åŠ åˆ° Cloudflare

### é”™è¯¯ 3: "Database not found"

**åŸå› **: æ•°æ®åº“æœªåˆ›å»ºæˆ– ID é”™è¯¯

**è§£å†³**:
1. è¿è¡Œ `wrangler d1 list` æŸ¥çœ‹æ•°æ®åº“åˆ—è¡¨
2. ç¡®è®¤ `wrangler.toml` ä¸­çš„ database_id æ­£ç¡®
3. é‡æ–°åˆ›å»ºæ•°æ®åº“

### é”™è¯¯ 4: "Email routing not enabled"

**åŸå› **: Email Routing æœªå¯ç”¨

**è§£å†³**:
1. è¿›å…¥ Cloudflare Dashboard
2. å¯ç”¨ Email Routing
3. æ·»åŠ å¹¶éªŒè¯ç›®æ ‡é‚®ç®±

---

## ğŸ“‹ é…ç½®æ¨¡æ¿

### workers/.dev.vars å®Œæ•´æ¨¡æ¿

```env
# ========================================
# Cloudflare API é…ç½®
# ========================================
CLOUDFLARE_API_TOKEN=your_cloudflare_api_token_here
CLOUDFLARE_ACCOUNT_ID=your_cloudflare_account_id_here
CLOUDFLARE_ZONE_ID=your_cloudflare_zone_id_here

# ========================================
# åŸŸåé…ç½®
# ========================================
DOMAIN_NAME=yourdomain.com

# ========================================
# é‚®ç®±é…ç½®
# ========================================
# ç›®æ ‡ QQ é‚®ç®±
TARGET_EMAIL=your@qq.com

# QQ é‚®ç®± IMAP æˆæƒç ï¼ˆä¸æ˜¯QQå¯†ç ï¼ï¼‰
QQ_IMAP_PASSWORD=your_sixteen_char_auth_code

# ========================================
# ç›‘æ§é…ç½®
# ========================================
# ç›‘æ§é—´éš”ï¼ˆç§’ï¼‰
MONITOR_INTERVAL=10

# è‡ªåŠ¨åˆ é™¤å¤©æ•°
AUTO_DELETE_DAYS=7
```

### frontend/.env å®Œæ•´æ¨¡æ¿

```env
# ========================================
# API é…ç½®
# ========================================
VITE_API_BASE=/api

# ========================================
# WebSocket é…ç½®
# ========================================
VITE_WS_URL=ws://localhost:8787/ws

# ========================================
# ç”Ÿäº§ç¯å¢ƒï¼ˆå–æ¶ˆæ³¨é‡Šå¹¶ä¿®æ”¹ï¼‰
# ========================================
# VITE_API_BASE=https://your-worker.workers.dev/api
# VITE_WS_URL=wss://your-worker.workers.dev/ws
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥

é…ç½®å®Œæˆåï¼š

1. è¿è¡Œæœ¬åœ°å¼€å‘æµ‹è¯•
2. éƒ¨ç½²åˆ° Cloudflare
3. æµ‹è¯•å®Œæ•´æµç¨‹
4. å¼€å§‹ä½¿ç”¨ç³»ç»Ÿ

---

## ğŸ’¡ é…ç½®æŠ€å·§

### å®‰å…¨å»ºè®®

1. **ä¸è¦æäº¤æ•æ„Ÿä¿¡æ¯åˆ° Git**
   - `.dev.vars` å·²åœ¨ `.gitignore` ä¸­
   - ä¸è¦å°† Token å†™å…¥ä»£ç 

2. **ä½¿ç”¨æœ€å°æƒé™åŸåˆ™**
   - API Token åªæˆäºˆå¿…è¦æƒé™
   - å®šæœŸè½®æ¢ Token

3. **å¤‡ä»½é…ç½®**
   - å°†é…ç½®ä¿å­˜åˆ°å®‰å…¨çš„åœ°æ–¹
   - ä½¿ç”¨å¯†ç ç®¡ç†å™¨

### å¤šç¯å¢ƒç®¡ç†

```bash
# å¼€å‘ç¯å¢ƒ
workers/.dev.vars

# æµ‹è¯•ç¯å¢ƒ
workers/.test.vars

# ç”Ÿäº§ç¯å¢ƒ
Cloudflare Dashboard é…ç½®
```

---

**é…ç½®å®Œæˆåï¼Œè¯·å‚è€ƒ [å¿«é€Ÿå¼€å§‹.md](./å¿«é€Ÿå¼€å§‹.md) ç»§ç»­éƒ¨ç½²ï¼**

