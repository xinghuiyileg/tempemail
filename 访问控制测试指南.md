# 🧪 访问控制功能测试指南

## 📋 测试清单

### ✅ 准备工作

- [ ] 已安装依赖 (`npm install`)
- [ ] 配置文件已更新
- [ ] 前后端服务已启动

---

## 🚀 本地测试步骤

### 步骤 1：配置访问密码

```bash
# 进入 workers 目录
cd workers

# 创建或编辑 .dev.vars 文件
echo "ACCESS_PASSWORD=test123456" >> .dev.vars
```

### 步骤 2：启动后端服务

```bash
# 在 workers 目录
npm run dev

# 等待输出
# ⎔ Starting local server...
# ⛅️ wrangler 4.x.x
# [wrangler:inf] Ready on http://localhost:8787
```

### 步骤 3：启动前端服务

```bash
# 新开一个终端，进入 frontend 目录
cd frontend
npm run dev

# 等待输出
# VITE v5.x.x ready in xxx ms
# ➜  Local:   http://localhost:5174/
```

### 步骤 4：访问前端

打开浏览器访问：**http://localhost:5174/**

---

## 🧪 功能测试

### 测试 1：检查认证状态 API ✅

```bash
curl http://localhost:8787/api/auth/check
```

**预期输出**：
```json
{
  "success": true,
  "data": {
    "enabled": true,
    "message": "访问控制已启用"
  }
}
```

---

### 测试 2：登录弹窗显示 ✅

**操作**：打开前端页面

**预期行为**：
- ✅ 自动显示登录弹窗
- ✅ 页面内容被遮罩
- ✅ 无法点击背景内容
- ✅ 输入框自动聚焦

**检查项**：
- [ ] 弹窗居中显示
- [ ] 背景半透明遮罩
- [ ] 标题显示"🔐 访问控制"
- [ ] 密码输入框可见
- [ ] 显示/隐藏密码按钮可用
- [ ] 登录按钮可见

---

### 测试 3：错误密码处理 ✅

**操作**：
1. 输入错误密码：`wrongpassword`
2. 点击"登录"按钮

**预期行为**：
- ✅ 显示加载状态
- ✅ 2秒后显示错误消息："密码错误，请重试"
- ✅ 输入框清空
- ✅ 弹窗不关闭
- ✅ 可以重新输入

**检查项**：
- [ ] 错误消息为红色背景
- [ ] 错误消息显示 2-3 秒
- [ ] 密码框自动清空并聚焦

---

### 测试 4：正确密码登录 ✅

**操作**：
1. 输入正确密码：`test123456`
2. 点击"登录"按钮（或按回车键）

**预期行为**：
- ✅ 显示加载状态
- ✅ 1秒后显示成功通知："登录成功！"
- ✅ 登录弹窗关闭
- ✅ 页面正常显示
- ✅ 可以正常使用所有功能

**检查项**：
- [ ] 成功通知为绿色
- [ ] 弹窗平滑关闭
- [ ] 邮箱列表正常加载
- [ ] 所有按钮可用

---

### 测试 5：令牌持久化 ✅

**操作**：
1. 登录成功后
2. 刷新页面（F5）

**预期行为**：
- ✅ 不再显示登录弹窗
- ✅ 直接进入系统
- ✅ 数据正常加载

**检查项**：
- [ ] 浏览器 localStorage 中存在 `auth_token`
- [ ] 令牌值与密码相同
- [ ] 页面刷新后不需要重新登录

**验证方法**：
```javascript
// 打开浏览器控制台执行
console.log(localStorage.getItem('auth_token'))
// 应输出：test123456
```

---

### 测试 6：API 请求认证 ✅

**操作**：登录后打开浏览器开发者工具 → Network 标签

**检查项**：
- [ ] 所有 `/api/*` 请求都包含 `Authorization` header
- [ ] Header 值为 `Bearer test123456`
- [ ] 请求返回 200 成功状态

**示例请求**：
```http
GET /api/emails HTTP/1.1
Authorization: Bearer test123456
```

---

### 测试 7：未认证请求拦截 ✅

**操作**：
1. 清除 localStorage：`localStorage.clear()`
2. 刷新页面
3. 尝试手动访问 API

```bash
curl http://localhost:8787/api/emails
```

**预期行为**：
- ✅ 返回 401 Unauthorized
- ✅ 包含 `WWW-Authenticate` header
- ✅ 错误消息："Unauthorized"

**预期输出**：
```json
{
  "success": false,
  "error": "Unauthorized"
}
```

---

### 测试 8：登出功能 ✅

**操作**：
1. 登录成功后，点击右上角"退出登录"按钮（图标：🚪）

**预期行为**：
- ✅ 显示成功通知："已退出登录"
- ✅ 页面自动刷新
- ✅ 重新显示登录弹窗
- ✅ localStorage 中的令牌被清除

**检查项**：
- [ ] 退出按钮可见（仅在已登录时）
- [ ] 退出后需要重新登录
- [ ] localStorage 中无 `auth_token`

---

### 测试 9：密码显示/隐藏切换 ✅

**操作**：
1. 在密码输入框输入密码
2. 点击眼睛图标按钮

**预期行为**：
- ✅ 密码明文/密文切换
- ✅ 图标在 👁️ 和 🚫👁️ 之间切换
- ✅ 输入内容不丢失

**检查项**：
- [ ] 默认为密码模式（***）
- [ ] 点击后切换为明文
- [ ] 再次点击切换回密文
- [ ] 输入内容保持不变

---

### 测试 10：禁用访问控制 ✅

**操作**：
1. 停止后端服务
2. 编辑 `.dev.vars`，删除或清空 `ACCESS_PASSWORD`
3. 重启后端服务
4. 刷新前端页面

**预期行为**：
- ✅ 不显示登录弹窗
- ✅ 直接进入系统
- ✅ 所有功能正常使用

**检查项**：
- [ ] 认证检查 API 返回 `enabled: false`
- [ ] 页面正常加载
- [ ] API 请求不需要 Authorization header

**验证命令**：
```bash
curl http://localhost:8787/api/auth/check
```

**预期输出**：
```json
{
  "success": true,
  "data": {
    "enabled": false,
    "message": "访问控制未启用"
  }
}
```

---

## 🔄 回归测试

### 测试 11：与现有功能兼容性 ✅

**操作**：登录后测试所有现有功能

**检查项**：
- [ ] ✅ 生成邮箱
- [ ] ✅ 复制邮箱地址
- [ ] ✅ 查看邮件列表
- [ ] ✅ 打开邮件详情
- [ ] ✅ 复制验证码
- [ ] ✅ 删除邮件
- [ ] ✅ 删除邮箱
- [ ] ✅ 系统配置
- [ ] ✅ 实时通知

**预期**：所有功能正常工作，不受访问控制影响

---

## 📱 响应式测试

### 测试 12：移动端登录 ✅

**操作**：
1. 打开浏览器开发者工具
2. 切换到移动设备模式（iPhone/Android）
3. 刷新页面

**检查项**：
- [ ] 登录弹窗适配屏幕
- [ ] 按钮大小适中（易点击）
- [ ] 输入框大小合适
- [ ] 文字清晰可读
- [ ] 弹窗不超出屏幕

---

## 🚀 生产环境测试

### 测试 13：部署到 Cloudflare ✅

**操作**：
```bash
# 1. 设置生产环境密码
cd workers
npx wrangler secret put ACCESS_PASSWORD
# 输入：YourProductionPassword2024!

# 2. 部署
npm run deploy

# 3. 测试
curl https://your-worker.workers.dev/api/auth/check
```

**预期**：
- ✅ 部署成功
- ✅ 认证接口返回 `enabled: true`
- ✅ 前端登录正常

---

## 📊 测试结果记录表

| 测试项 | 状态 | 备注 |
|-------|------|------|
| 1. 认证状态 API | ⬜ | |
| 2. 登录弹窗显示 | ⬜ | |
| 3. 错误密码处理 | ⬜ | |
| 4. 正确密码登录 | ⬜ | |
| 5. 令牌持久化 | ⬜ | |
| 6. API 请求认证 | ⬜ | |
| 7. 未认证拦截 | ⬜ | |
| 8. 登出功能 | ⬜ | |
| 9. 密码显示切换 | ⬜ | |
| 10. 禁用访问控制 | ⬜ | |
| 11. 功能兼容性 | ⬜ | |
| 12. 移动端适配 | ⬜ | |
| 13. 生产环境 | ⬜ | |

---

## 🐛 常见问题

### Q1：登录后仍显示 401 错误
**A**：检查 axios header 是否正确设置
```javascript
// 控制台执行
console.log(axios.defaults.headers.common['Authorization'])
// 应输出：Bearer test123456
```

### Q2：刷新页面后需要重新登录
**A**：检查 localStorage 是否被清除
```javascript
// 控制台执行
console.log(localStorage.getItem('auth_token'))
// 应有值
```

### Q3：密码正确但无法登录
**A**：检查后端密码配置
```bash
# 查看 .dev.vars
cat workers/.dev.vars | grep ACCESS_PASSWORD
```

---

## ✅ 测试通过标准

### 基本功能（必须通过）
- [x] 认证状态检查正常
- [x] 登录弹窗正常显示
- [x] 密码验证正确
- [x] 令牌持久化有效
- [x] API 认证拦截生效

### 用户体验（建议通过）
- [x] 登录过程流畅
- [x] 错误提示清晰
- [x] 界面美观友好
- [x] 响应式适配良好

### 安全性（重要）
- [x] 未认证请求被拦截
- [x] 错误密码无法登录
- [x] 令牌验证有效
- [x] 登出完全清理状态

---

## 🎉 测试完成

完成以上所有测试后，访问控制功能即可正式使用！

**最后检查**：
```bash
# 1. 后端服务运行正常
curl http://localhost:8787/health

# 2. 前端服务运行正常
curl http://localhost:5174/

# 3. 认证功能正常
curl http://localhost:8787/api/auth/check
```

祝测试顺利！🚀

