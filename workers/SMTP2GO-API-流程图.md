# SMTP2GO API 使用情况获取流程

## 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                    应用程序                                  │
│                                                              │
│  调用: getSMTP2GOQuota(apiKey, db)                          │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│              emailQuota.js 服务层                            │
│                                                              │
│  ┌────────────────────────────────────────────────────┐    │
│  │  1. 尝试调用 SMTP2GO API                           │    │
│  │     POST /stats/email_cycle                        │    │
│  │     Headers: X-Smtp2go-Api-Key                     │    │
│  └────────────────┬───────────────────────────────────┘    │
│                   │                                          │
│                   ▼                                          │
│         ┌─────────────────┐                                 │
│         │  API 调用成功？  │                                 │
│         └────┬────────┬───┘                                 │
│              │ YES    │ NO                                   │
│              ▼        ▼                                      │
│    ┌─────────────┐  ┌──────────────────────────┐          │
│    │ 返回 API 数据│  │ 2. 回退到数据库统计      │          │
│    │             │  │    getSMTP2GOQuotaFromDB()│          │
│    │ - 实时准确  │  │                           │          │
│    │ - 包含周期  │  │ - 查询 sent_emails 表    │          │
│    │ - 所有来源  │  │ - 统计本月发送数量       │          │
│    └─────────────┘  │ - 基于限额计算剩余       │          │
│                     └──────────────────────────┘          │
└─────────────────────────────────────────────────────────────┘
```

## 详细流程

### 方案 A: API 方式（推荐）

```
开始
  │
  ▼
准备 API 请求
  │
  ├─ URL: https://api.smtp2go.com/v3/stats/email_cycle
  ├─ Method: POST
  ├─ Headers:
  │    ├─ Content-Type: application/json
  │    └─ X-Smtp2go-Api-Key: api-XXXXXXXX
  └─ Body: {}
  │
  ▼
发送 HTTP 请求
  │
  ▼
┌─────────────────┐
│ 检查响应状态码   │
└────┬────────┬───┘
     │ 200    │ 400/其他
     ▼        ▼
  ┌─────┐  ┌──────────┐
  │成功 │  │失败/权限不足│
  └──┬──┘  └─────┬────┘
     │           │
     ▼           ▼
解析 JSON    回退到方案 B
     │
     ▼
提取数据:
  ├─ cycle_start: "2024-11-01"
  ├─ cycle_end: "2024-11-30"
  ├─ sent: 150
  ├─ remaining: 850
  └─ allowance: 1000
     │
     ▼
格式化返回:
  {
    success: true,
    service: 'SMTP2GO',
    total: 1000,
    used: 150,
    remaining: 850,
    percentage: 85,
    cycleStart: '2024-11-01',
    cycleEnd: '2024-11-30',
    note: '通过 SMTP2GO API 实时获取'
  }
     │
     ▼
   结束
```

### 方案 B: 数据库统计（备用）

```
开始（从方案 A 失败回退）
  │
  ▼
获取当前月份
  │
  ├─ 月初: 2024-11-01 00:00:00
  └─ 月末: 2024-11-30 23:59:59
  │
  ▼
查询数据库
  │
  SQL: SELECT COUNT(*) 
       FROM sent_emails 
       WHERE provider = 'SMTP2GO'
       AND sent_at >= '2024-11-01'
       AND sent_at <= '2024-11-30'
  │
  ▼
获取发送数量
  │
  例如: sent = 150
  │
  ▼
计算剩余额度
  │
  ├─ 总限额: 1000 (免费版默认)
  ├─ 已使用: 150
  └─ 剩余: 1000 - 150 = 850
  │
  ▼
格式化返回:
  {
    success: true,
    service: 'SMTP2GO',
    total: 1000,
    used: 150,
    remaining: 850,
    percentage: 85,
    note: '基于数据库统计（API 不可用）'
  }
  │
  ▼
结束
```

## API 权限配置流程

```
开始
  │
  ▼
访问 SMTP2GO 控制台
https://app-us.smtp2go.com/settings/api_keys
  │
  ▼
┌─────────────────────┐
│ 是否有现有 API Key？ │
└────┬────────┬───────┘
     │ YES    │ NO
     ▼        ▼
  编辑现有   创建新的
  API Key    API Key
     │        │
     └────┬───┘
          ▼
配置权限:
  ├─ ✅ Send Email
  ├─ ✅ Statistics  ← 重要！
  └─ ✅ View API Keys
          │
          ▼
      保存更改
          │
          ▼
      复制 API Key
          │
          ▼
更新环境变量:
  SMTP2GO_API_KEY=api-XXXXXXXX
          │
          ▼
      运行测试脚本
          │
          ▼
    ┌─────────────┐
    │ 测试是否成功？│
    └──┬──────┬───┘
       │ YES  │ NO
       ▼      ▼
     完成   重新检查权限
```

## 测试流程

### 快速测试

```
cd workers
  │
  ▼
运行权限检查脚本
.\check-smtp2go-permissions.ps1
  │
  ▼
┌──────────────────┐
│ 权限检查结果？    │
└───┬──────────┬───┘
    │ SUCCESS  │ FAILED
    ▼          ▼
  权限正常   需要配置权限
    │          │
    │          ├─ 打开浏览器
    │          ├─ 编辑 API Key
    │          ├─ 启用 Statistics
    │          └─ 重新测试
    │
    ▼
  完成配置
```

### 全面测试

```
cd workers
  │
  ▼
运行全面测试脚本
node test-all-smtp2go-stats.js
  │
  ▼
测试 5 个端点:
  ├─ /stats/email_cycle      ⭐ 推荐
  ├─ /stats/email_bounces
  ├─ /stats/email_summary
  ├─ /stats/email_spam
  └─ /stats/email_unsubscribes
  │
  ▼
生成测试报告:
  ├─ 成功端点数量
  ├─ 失败端点数量
  ├─ 详细错误信息
  └─ 配置建议
  │
  ▼
查看结果并采取行动
```

## 数据流向

```
┌──────────────┐
│  用户请求    │
│  查看配额    │
└──────┬───────┘
       │
       ▼
┌──────────────────────┐
│  Cloudflare Workers  │
│  (Backend API)       │
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│  emailQuota.js       │
│  getSMTP2GOQuota()   │
└──────┬───────────────┘
       │
       ├─────────────────────┐
       │                     │
       ▼                     ▼
┌──────────────┐      ┌──────────────┐
│ SMTP2GO API  │      │ Cloudflare D1│
│ (首选)       │      │ (备用)       │
└──────┬───────┘      └──────┬───────┘
       │                     │
       │  实时数据            │  历史数据
       │  - 准确             │  - 本地
       │  - 完整             │  - 快速
       │                     │
       └─────────┬───────────┘
                 │
                 ▼
         ┌───────────────┐
         │  格式化数据   │
         │  返回给前端   │
         └───────────────┘
```

## 错误处理流程

```
API 调用
  │
  ▼
┌─────────────────┐
│ 捕获异常/错误？  │
└────┬────────┬───┘
     │ YES    │ NO
     ▼        ▼
  错误类型   返回成功
     │
     ├─ 权限不足 (400)
     │    └─> 回退到数据库
     │
     ├─ 网络错误
     │    └─> 回退到数据库
     │
     ├─ 超时
     │    └─> 回退到数据库
     │
     └─ 其他错误
          └─> 回退到数据库
```

## 使用场景

### 场景 1: 正常使用（有权限）

```
用户 → 应用 → API → SMTP2GO → 返回实时数据 → 显示给用户
                                ✅ 最准确
```

### 场景 2: 权限不足

```
用户 → 应用 → API → SMTP2GO (权限拒绝)
                      ↓
                   数据库统计 → 返回估算数据 → 显示给用户
                                ⚠️ 仅本地数据
```

### 场景 3: 网络故障

```
用户 → 应用 → API → SMTP2GO (网络错误)
                      ↓
                   数据库统计 → 返回估算数据 → 显示给用户
                                ⚠️ 仅本地数据
```

## 总结

### 优先级

1. **首选**: SMTP2GO API (`/stats/email_cycle`)
   - ✅ 实时准确
   - ✅ 包含周期信息
   - ✅ 统计所有来源

2. **备用**: 数据库统计
   - ✅ 无需权限
   - ✅ 快速响应
   - ⚠️ 仅本地数据

### 关键点

- 🔑 **权限是关键**: 需要在 SMTP2GO 控制台启用 Statistics 权限
- 🔄 **自动回退**: API 失败时自动使用数据库统计
- 📊 **多个端点**: 可根据需求选择不同的统计端点
- 🧪 **完善测试**: 提供多个测试工具验证配置

